generate-client:
  stage: generate
  extends:
    - .use-service-image
  variables:
    GIT_DEPTH: 0
    GIT_STRATEGY: 'clone'
    GITLAB_REPOSITORY_URL: 'https://ci:${GITLAB_TOKEN_REPOSITORY_WRITE}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git'
  before_script:
    - git config --global --add safe.directory ${CI_PROJECT_DIR}
    - ls -al
    - env
  script:
    - '## Check requirements'
    - |
      if [ -z "${openapi_url}" ]; then
        echo "Missing variable openapi_url"
        exit 1
      fi
    - '## Download the new openapi.json'
    - curl -sS --fail-with-body -o openapi.json ${openapi_url}
    - '## Check for openapi changes'
    - |
      if git diff --name-only --exit-code --quiet openapi.json; then
        echo "No changes in openapi.json detected -> skipping client generation."
        # stop further execution of this job
        exit 0
      fi
    - '## Install dev dependencies'
    - composer install --dev
    - '## Generate the client'
    - php vendor/bin/jane-openapi generate -c jane-openapi-configuration.php
    - '## Add changes to git commit stage'
    - git add -A
    - '## Check for client changes'
    - |
      changes=$(git diff --cached --name-only | grep -v -w "^openapi.json$" || true)
      if [ -z "$changes" ]; then
        echo "No changes in the generated client code detected -> skipping commit."
        # stop further execution of this job
        exit 0
      fi
    - '## Commit and push to approval branch'
    - git config user.email ${GIT_USER_EMAIL}
    - git config user.name ${GIT_USER_NAME}
    - APPROVAL_BRANCH_NAME="approval/${CI_COMMIT_BRANCH}/$(date +%Y%m%d-%H%M%S)_${CI_JOB_ID}"
    - git checkout -b ${APPROVAL_BRANCH_NAME}
    - git commit -m 'Autogenerated client update [publish]'
    - >
      git push \
        -o merge_request.create \
        -o merge_request.remove_source_branch \
        -o merge_request.target=${CI_COMMIT_BRANCH} \
        -o merge_request.assign=${GITLAB_USER_LOGIN} \
        --set-upstream ${GITLAB_REPOSITORY_URL} ${APPROVAL_BRANCH_NAME}
  cache:
    key:
      prefix: '${CI_PROJECT_PATH_SLUG}-dev'
      files:
        - composer.lock
    paths:
      - vendor
